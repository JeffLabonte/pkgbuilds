# Maintainer: Mark Wagie <yochanan dot marqos at gmail dot com>
pkgname=mullvad-vpn
pkgver=2019.9
pkgrel=7
pkgdesc="The Mullvad VPN client app for desktop"
url="https://www.mullvad.net"
arch=('x86_64')
license=('GPL3')
depends=('libnotify' 'libappindicator-gtk3' 'libxss' 'nss')
makedepends=('git' 'unzip' 'wget' 'curl' 'osslsigncode' 'cmake' 'go' 'dbus' 'cargo' 'npm')
             #'mingw-w64-gcc' 'dos2unix' 'nsis' 'arm-linux-gnueabi-gcc'
install="$pkgname.install"
_binariescommit=14ce537f70e660f8e5ff29a5b969510e6079243a
_libmnlver=libmnl-1.0.4
_libnftnlver=libnftnl-1.1.4
_libsodiumver=1.0.18
_lz4ver=v1.8.2
_opensslver=OpenSSL_1_1_1d
_openvpncommit=7d79801519e3f6bc5e813bc578effe28b56a2ca8
_openvpnbuildcommit=530a7fd008713cd36c6fadaf7869c9f1cc9102e0
_shadowsocksrustcommit=acc14d4fc1f2c21ab2f7bd7b2ff8620346852c00
source=("$pkgname-$pkgver.tar.gz::https://github.com/mullvad/mullvadvpn-app/archive/$pkgver.tar.gz"
        "git+https://github.com/mullvad/mullvadvpn-app-binaries.git#commit=$_binariescommit"
        "git+https://git.netfilter.org/libmnl#tag=$_libmnlver"
        "git+https://git.netfilter.org/libnftnl#tag=$_libnftnlver"
        "git+https://github.com/jedisct1/libsodium.git#tag=$_libsodiumver"
        "git+https://github.com/lz4/lz4.git#tag=$_lz4ver"
        "git+https://github.com/openssl/openssl.git#tag=$_opensslver"
        "git+https://github.com/mullvad/openvpn.git#commit=$_openvpncommit"
        "git+https://github.com/mullvad/openvpn-build.git#commit=$_openvpnbuildcommit"
        "git+https://github.com/shadowsocks/shadowsocks-rust.git#commit=$_shadowsocksrustcommit")
sha256sums=('7966694defe048eb320142cac711756e4fc42cb503de7c2fc1e93b7be04aad6b'
            'SKIP'
            'SKIP'
            'SKIP'
            'SKIP'
            'SKIP'
            'SKIP'
            'SKIP'
            'SKIP'
            'SKIP')

prepare() {
	cd "$srcdir/mullvadvpn-app-binaries"
	for submodule in libmnl libnftnl libsodium lz4 openssl openvpn openvpn-build shadowsocks-rust; do
		git submodule init "${submodule}"
		git config submodule."${submodule}".url ../"${submodule#*/}"
		git submodule update "${submodule}"
	done

	rm -rf "$srcdir/binaries"
	mv "$srcdir/mullvadvpn-app-binaries" "$srcdir/binaries"
	rm -rf "$srcdir/mullvadvpn-app-$pkgver/dist-assets/binaries"
	ln -s "$srcdir/binaries" "$srcdir/mullvadvpn-app-$pkgver/dist-assets/binaries"

	sed -i 's/shell uname -s/uname -s/g' Makefile
}

build() {
	cd "$srcdir/mullvadvpn-app-$pkgver/dist-assets/binaries"

	# Build dependencies
	make openvpn

	make wireguard-go

	make update_openssl

	make libnftnl

	make libsodium

	make shadowsocks

	cd "$srcdir/mullvadvpn-app-$pkgver"

	# Build mullvad-daemon
	export LIBMNL_LIB_DIR="dist-assets/binaries/$TARGET"
	export LIBNFTNL_LIB_DIR="dist-assets/binaries/$TARGET"

	export OPENSSL_STATIC="1"
	export OPENSSL_LIB_DIR="dist-assets/binaries/$TARGET"
	export OPENSSL_INCLUDE_DIR="dist-assets/binaries/$TARGET/include"

	cargo build

	# Build Electron GUI app
	cd gui
	npm install --cache "${srcdir}/npm-cache"
	npm run pack:linux
}

check() {
	cd "$srcdir/mullvadvpn-app-$pkgver"
	npm test
}

package() {
	cd "$srcdir/mullvadvpn-app-$pkgver"

}
